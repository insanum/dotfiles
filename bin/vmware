#!/usr/bin/env bash
# VMware Fusion VM Management Script
# Manages VMware Fusion VMs via vmrun command-line tool

set -euo pipefail

# Configuration
VM_DIR="$HOME/Virtual Machines.localized"
VMRUN="/Applications/VMware Fusion.app/Contents/Library/vmrun"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if vmrun exists
check_vmrun() {
    if [[ ! -f "$VMRUN" ]]; then
        echo -e "${RED}Error: vmrun not found at $VMRUN${NC}" >&2
        echo "Please ensure VMware Fusion is installed." >&2
        exit 1
    fi
}

# Get all VM paths
get_all_vms() {
    find "$VM_DIR" -name "*.vmx" -type f 2>/dev/null | sort
}

# Get VM display name from path
get_vm_name() {
    local vmx_path="$1"
    local vm_dir
    vm_dir=$(dirname "$vmx_path")
    basename "$vm_dir" .vmwarevm
}

# Get running VMs
get_running_vms() {
    "$VMRUN" -T fusion list 2>/dev/null | tail -n +2
}

# Check if VM is running
is_running() {
    local vmx_path="$1"
    get_running_vms | grep -qF "$vmx_path"
}

# List all VMs with their status
cmd_list() {
    local all_vms running_vms

    if [[ ! -d "$VM_DIR" ]]; then
        echo -e "${RED}Error: VM directory not found: $VM_DIR${NC}" >&2
        exit 1
    fi

    all_vms=$(get_all_vms)

    if [[ -z "$all_vms" ]]; then
        echo "No VMs found in $VM_DIR"
        exit 0
    fi

    running_vms=$(get_running_vms)

    echo -e "${BLUE}Available VMs:${NC}"
    echo

    local index=1
    while IFS= read -r vmx_path; do
        local vm_name status_color status_text
        vm_name=$(get_vm_name "$vmx_path")

        if is_running "$vmx_path"; then
            status_color="$GREEN"
            status_text="RUNNING"
        else
            status_color="$YELLOW"
            status_text="STOPPED"
        fi

        echo -e "${index}. ${vm_name}"
        echo -e "   Status: ${status_color}${status_text}${NC}"
        echo -e "   Path: ${vmx_path}"
        echo
        ((index++))
    done <<< "$all_vms"
}

# Show detailed status of running VMs
cmd_status() {
    local running_vms
    running_vms=$(get_running_vms)

    if [[ -z "$running_vms" ]]; then
        echo "No VMs currently running"
        exit 0
    fi

    echo -e "${GREEN}Running VMs:${NC}"
    echo

    local index=1
    while IFS= read -r vmx_path; do
        local vm_name
        vm_name=$(get_vm_name "$vmx_path")

        echo -e "${index}. ${vm_name}"
        echo -e "   Path: ${vmx_path}"
        echo
        ((index++))
    done <<< "$running_vms"
}

# Find VM by name or index
find_vm() {
    local query="$1"
    local all_vms
    all_vms=$(get_all_vms)

    # If query is a number, treat as index
    if [[ "$query" =~ ^[0-9]+$ ]]; then
        echo "$all_vms" | sed -n "${query}p"
        return
    fi

    # Otherwise search by name (case-insensitive, partial match)
    local result
    result=$(echo "$all_vms" | while IFS= read -r vmx_path; do
        local vm_name
        vm_name=$(get_vm_name "$vmx_path")
        if [[ "${vm_name,,}" == *"${query,,}"* ]]; then
            echo "$vmx_path"
        fi
    done)

    if [[ -z "$result" ]]; then
        echo -e "${RED}Error: VM not found: $query${NC}" >&2
        exit 1
    fi

    # If multiple matches, return first one and warn
    local count
    count=$(echo "$result" | wc -l)
    if [[ $count -gt 1 ]]; then
        echo -e "${YELLOW}Warning: Multiple VMs match '$query', using first match${NC}" >&2
    fi

    echo "$result" | head -n1
}

# Start a VM
cmd_start() {
    local vm_name="${1:-}"
    local gui="${2:-gui}"

    if [[ -z "$vm_name" ]]; then
        echo "Usage: vmware start <vm-name-or-index> [gui|nogui]" >&2
        exit 1
    fi

    local vmx_path
    vmx_path=$(find_vm "$vm_name")

    if is_running "$vmx_path"; then
        echo -e "${YELLOW}VM is already running: $(get_vm_name "$vmx_path")${NC}"
        exit 0
    fi

    echo -e "${BLUE}Starting VM: $(get_vm_name "$vmx_path")${NC}"
    "$VMRUN" -T fusion start "$vmx_path" "$gui"
    echo -e "${GREEN}VM started successfully${NC}"
}

# Stop a VM
cmd_stop() {
    local vm_name="${1:-}"
    local mode="${2:-soft}"

    if [[ -z "$vm_name" ]]; then
        echo "Usage: vmware stop <vm-name-or-index> [hard|soft]" >&2
        exit 1
    fi

    local vmx_path
    vmx_path=$(find_vm "$vm_name")

    if ! is_running "$vmx_path"; then
        echo -e "${YELLOW}VM is not running: $(get_vm_name "$vmx_path")${NC}"
        exit 0
    fi

    echo -e "${BLUE}Stopping VM: $(get_vm_name "$vmx_path")${NC}"
    "$VMRUN" -T fusion stop "$vmx_path" "$mode"
    echo -e "${GREEN}VM stopped successfully${NC}"
}

# Suspend a VM
cmd_suspend() {
    local vm_name="${1:-}"
    local mode="${2:-soft}"

    if [[ -z "$vm_name" ]]; then
        echo "Usage: vmware suspend <vm-name-or-index> [hard|soft]" >&2
        exit 1
    fi

    local vmx_path
    vmx_path=$(find_vm "$vm_name")

    if ! is_running "$vmx_path"; then
        echo -e "${YELLOW}VM is not running: $(get_vm_name "$vmx_path")${NC}"
        exit 0
    fi

    echo -e "${BLUE}Suspending VM: $(get_vm_name "$vmx_path")${NC}"
    "$VMRUN" -T fusion suspend "$vmx_path" "$mode"
    echo -e "${GREEN}VM suspended successfully${NC}"
}

# Pause a VM
cmd_pause() {
    local vm_name="${1:-}"

    if [[ -z "$vm_name" ]]; then
        echo "Usage: vmware pause <vm-name-or-index>" >&2
        exit 1
    fi

    local vmx_path
    vmx_path=$(find_vm "$vm_name")

    if ! is_running "$vmx_path"; then
        echo -e "${YELLOW}VM is not running: $(get_vm_name "$vmx_path")${NC}"
        exit 0
    fi

    echo -e "${BLUE}Pausing VM: $(get_vm_name "$vmx_path")${NC}"
    "$VMRUN" -T fusion pause "$vmx_path"
    echo -e "${GREEN}VM paused successfully${NC}"
}

# Unpause a VM
cmd_unpause() {
    local vm_name="${1:-}"

    if [[ -z "$vm_name" ]]; then
        echo "Usage: vmware unpause <vm-name-or-index>" >&2
        exit 1
    fi

    local vmx_path
    vmx_path=$(find_vm "$vm_name")

    echo -e "${BLUE}Unpausing VM: $(get_vm_name "$vmx_path")${NC}"
    "$VMRUN" -T fusion unpause "$vmx_path"
    echo -e "${GREEN}VM unpaused successfully${NC}"
}

# Reset a VM
cmd_reset() {
    local vm_name="${1:-}"
    local mode="${2:-soft}"

    if [[ -z "$vm_name" ]]; then
        echo "Usage: vmware reset <vm-name-or-index> [hard|soft]" >&2
        exit 1
    fi

    local vmx_path
    vmx_path=$(find_vm "$vm_name")

    if ! is_running "$vmx_path"; then
        echo -e "${YELLOW}VM is not running: $(get_vm_name "$vmx_path")${NC}"
        exit 0
    fi

    echo -e "${BLUE}Resetting VM: $(get_vm_name "$vmx_path")${NC}"
    "$VMRUN" -T fusion reset "$vmx_path" "$mode"
    echo -e "${GREEN}VM reset successfully${NC}"
}

# Create a snapshot
cmd_snapshot() {
    local vm_name="${1:-}"
    local snapshot_name="${2:-}"

    if [[ -z "$vm_name" ]] || [[ -z "$snapshot_name" ]]; then
        echo "Usage: vmware snapshot <vm-name-or-index> <snapshot-name>" >&2
        exit 1
    fi

    local vmx_path
    vmx_path=$(find_vm "$vm_name")

    echo -e "${BLUE}Creating snapshot '$snapshot_name' for VM: $(get_vm_name "$vmx_path")${NC}"
    "$VMRUN" -T fusion snapshot "$vmx_path" "$snapshot_name"
    echo -e "${GREEN}Snapshot created successfully${NC}"
}

# List snapshots
cmd_snapshots() {
    local vm_name="${1:-}"
    local show_tree="${2:-}"

    if [[ -z "$vm_name" ]]; then
        echo "Usage: vmware snapshots <vm-name-or-index> [tree]" >&2
        exit 1
    fi

    local vmx_path
    vmx_path=$(find_vm "$vm_name")

    echo -e "${BLUE}Snapshots for VM: $(get_vm_name "$vmx_path")${NC}"
    echo

    local args=("$vmx_path")
    if [[ "$show_tree" == "tree" ]]; then
        args+=("showTree")
    fi

    "$VMRUN" -T fusion listSnapshots "${args[@]}" 2>&1 || echo "No snapshots found"
}

# Revert to snapshot
cmd_revert() {
    local vm_name="${1:-}"
    local snapshot_name="${2:-}"

    if [[ -z "$vm_name" ]] || [[ -z "$snapshot_name" ]]; then
        echo "Usage: vmware revert <vm-name-or-index> <snapshot-name>" >&2
        exit 1
    fi

    local vmx_path
    vmx_path=$(find_vm "$vm_name")

    echo -e "${BLUE}Reverting VM to snapshot '$snapshot_name': $(get_vm_name "$vmx_path")${NC}"
    "$VMRUN" -T fusion revertToSnapshot "$vmx_path" "$snapshot_name"
    echo -e "${GREEN}Reverted to snapshot successfully${NC}"
}

# Delete snapshot
cmd_delete_snapshot() {
    local vm_name="${1:-}"
    local snapshot_name="${2:-}"
    local delete_children="${3:-}"

    if [[ -z "$vm_name" ]] || [[ -z "$snapshot_name" ]]; then
        echo "Usage: vmware delete-snapshot <vm-name-or-index> <snapshot-name> [andDeleteChildren]" >&2
        exit 1
    fi

    local vmx_path
    vmx_path=$(find_vm "$vm_name")

    echo -e "${BLUE}Deleting snapshot '$snapshot_name' from VM: $(get_vm_name "$vmx_path")${NC}"

    local args=("$vmx_path" "$snapshot_name")
    if [[ "$delete_children" == "andDeleteChildren" ]]; then
        args+=("andDeleteChildren")
    fi

    "$VMRUN" -T fusion deleteSnapshot "${args[@]}"
    echo -e "${GREEN}Snapshot deleted successfully${NC}"
}

# Show IP address of a VM
cmd_ip() {
    local vm_name="${1:-}"

    if [[ -z "$vm_name" ]]; then
        echo "Usage: vmware ip <vm-name-or-index>" >&2
        exit 1
    fi

    local vmx_path
    vmx_path=$(find_vm "$vm_name")

    if ! is_running "$vmx_path"; then
        echo -e "${YELLOW}VM is not running: $(get_vm_name "$vmx_path")${NC}"
        exit 1
    fi

    echo -e "${BLUE}Getting IP address for VM: $(get_vm_name "$vmx_path")${NC}"
    "$VMRUN" -T fusion getGuestIPAddress "$vmx_path" -wait
}

# Show help
cmd_help() {
    cat << 'EOF'
VMware Fusion VM Management Tool

USAGE:
    vmware <command> [arguments]

COMMANDS:
    list                            List all VMs with their status
    status                          Show currently running VMs

    start <vm> [gui|nogui]          Start a VM (default: gui)
    stop <vm> [hard|soft]           Stop a VM (default: soft)
    suspend <vm> [hard|soft]        Suspend a VM (default: soft)
    pause <vm>                      Pause a VM
    unpause <vm>                    Unpause a VM
    reset <vm> [hard|soft]          Reset a VM (default: soft)

    snapshot <vm> <name>            Create a snapshot
    snapshots <vm> [tree]           List snapshots (optionally as tree)
    revert <vm> <snapshot>          Revert to a snapshot
    delete-snapshot <vm> <snapshot> Delete a snapshot
                    [andDeleteChildren]

    ip <vm>                         Get IP address of running VM

    help                            Show this help message

ARGUMENTS:
    <vm>        VM name (partial match, case-insensitive) or index number
    <name>      Snapshot name
    <snapshot>  Snapshot name

EXAMPLES:
    vmware list
    vmware start ubuntu13
    vmware start 1 nogui
    vmware stop ubuntu soft
    vmware snapshot ubuntu13 "before-upgrade"
    vmware snapshots ubuntu13 tree
    vmware revert ubuntu13 "before-upgrade"
    vmware ip ubuntu42

NOTES:
    - VM names support partial matching (case-insensitive)
    - You can use VM index numbers from the 'list' command
    - Default VM directory: ~/Virtual Machines.localized
EOF
}

# Main command dispatcher
main() {
    check_vmrun

    local command="${1:-help}"
    shift || true

    case "$command" in
        list|ls)
            cmd_list "$@"
            ;;
        status|ps)
            cmd_status "$@"
            ;;
        start|run)
            cmd_start "$@"
            ;;
        stop|halt|shutdown)
            cmd_stop "$@"
            ;;
        suspend|sleep)
            cmd_suspend "$@"
            ;;
        pause)
            cmd_pause "$@"
            ;;
        unpause|resume)
            cmd_unpause "$@"
            ;;
        reset|reboot|restart)
            cmd_reset "$@"
            ;;
        snapshot|snap)
            cmd_snapshot "$@"
            ;;
        snapshots|snaps|list-snapshots)
            cmd_snapshots "$@"
            ;;
        revert|revert-to-snapshot)
            cmd_revert "$@"
            ;;
        delete-snapshot|del-snapshot|remove-snapshot)
            cmd_delete_snapshot "$@"
            ;;
        ip|getip|ipaddress)
            cmd_ip "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            echo -e "${RED}Unknown command: $command${NC}" >&2
            echo "Run 'vmware help' for usage information" >&2
            exit 1
            ;;
    esac
}

main "$@"
